<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>profile</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
</head>
<body>

<!-- ヘッダー---------------------------------------------------------------- -->
<div id="header">

  <div class="logo">
    <img src="../static/img/bandme_logo.png" alt="bandme Logo">
  </div>

  <nav>
    <ul>
      <li>
        <a href="{{ url_for('home') }}">
          <img src="../static/img/home_icon.png" alt="chat">
          <span class="tooltip">ホーム</span>
        </a>
      </li>
      <li>
        <a href="#" id="chatLauncher">
          <img src="../static/img/chat_icon.png" alt="chat">
          <span class="tooltip">チャット</span>
        </a>
      </li>
    </ul>
  </nav>

  <div id="profile">
    <a href="{{ url_for('profile') }}" id="profileIconLink">
      <img id="profileIcon" src="{{ header_avatar }}" alt="Profile">
    </a>
  </div>

</div>
<!-- ヘッダー---------------------------------------------------------------- -->


<div class="profile-layout">
  <div class="profile-header">
    <img class="profile-icon" src="{{ avatar }}" alt="">

    <div class="profile-main">
      <div class="profile-user-row">

        <div class="profile-top">
          <div class="profile-name">
            <span class="profile-username">{{ user['username'] }}</span>
            {% if role == "individual" %}
              <span class="profile-type">個人</span>
            {% else %}
              <span class="profile-type">バンド</span>
            {% endif %}
          </div>

          <!-- ✅ SETTINGS MENU (ONLY ONE) -->
          <div class="settings-wrap">
            <button id="settingsIconLink" class="settings-btn">⚙</button>

            <div id="settingsMenu" class="settings-menu" hidden>
              <ul>
                <li><a href="#" id="editAccountBtn">アカウントを編集</a></li>
                <li><a href="/logout">ログアウト</a></li>
                <li><a href="#" id="deleteAccountBtn">アカウントを削除</a></li>
              </ul>
            </div>
          </div>
        </div>


        <!-- ✅ アカウント削除 Popup ----------------- -->
        <div class="popup" id="deletePopup" hidden>
          <div class="popup-content">
            <div class="popup-head">
              <h2>アカウントを削除</h2>
              <button type="button" class="popup-close" id="closeDeletePopup">×</button>
            </div>

            <p style="margin: 16px 0; line-height: 1.6;">
              この操作は取り消せません。削除するにはパスワードを入力してください。
            </p>

            <form id="deleteAccountForm">
              <label style="display:block; font-weight:bold; margin: 10px 0 6px;">パスワード</label>
              <input
                id="deletePassword"
                type="password"
                name="password"
                required
                style="width:100%; padding:10px 12px; border:1px solid #ccc; border-radius:8px; font-size:16px;"
              />

              <div style="display:flex; justify-content:flex-end; gap:10px; margin-top: 18px;">
                <button type="button" class="secondary" id="cancelDeletePopup">
                  キャンセル
                </button>
                <button type="submit" class="danger">
                  削除
                </button>
              </div>

              <div id="deleteError" style="color:red; font-weight:bold; margin-top:12px;" hidden></div>
            </form>
          </div>
        </div>
        <!-- ✅ アカウント削除 Popup ----------------- -->


        <!-- ✅ アカウント編集 Popup ----------------- -->
        <div class="popup" id="editPopup" hidden>
          <div class="popup-content">

            <div class="popup-head">
              <h2>アカウントを編集</h2>
              <button type="button" class="popup-close" id="closePopup">×</button>
            </div>

            <form method="POST"
                  action="{{ url_for('update_profile') }}"
                  enctype="multipart/form-data">

              <div class="icon-edit">
                <img id="currentIcon" src="{{ avatar }}" alt="icon">

                <label class="edit-btn" for="iconInput" title="アイコンを変更">
                  <img src="{{ url_for('static', filename='../static/img/edit_icon.png') }}" alt="edit">
                </label>

                <input id="iconInput" type="file" name="icon" accept="image/*" hidden>
              </div>

              <div class="username-edit">
                <label>ユーザー名</label>
                <input class="username-input"
                       type="text"
                       name="username"
                       value="{{ user['username'] }}"
                       required>
              </div>

              <div class="bio-edit">
                <label>自己紹介</label>
                <textarea class="bio-textarea"
                          name="bio"
                          rows="4">{{ user['bio'] }}</textarea>
              </div>

              <button type="submit">保存</button>
            </form>

          </div>
        </div>
        <!-- ✅ アカウント編集 Popup ----------------- -->


        <div class="profile-bottom">
          <button type="button" id="followersBtn" class="count-btn">
            <span class="follower-count">{{ follower_count or 0 }}</span>
            <span class="profile-follower">フォロワー</span>
          </button>

          <button type="button" id="followingBtn" class="count-btn">
            <span class="following-count">{{ following_count or 0 }}</span>
            <span class="profile-follow">フォロー</span>
          </button>
        </div>

      </div>

      <div class="profile-bio">{{ user['bio'] }}</div>
    </div>

  </div>
</div>


<!-- ✅ Showcase (from showcase_items table) -->
<div class="profile-layout-showcase">
  <div class="showcase-header">
    <h1>ショーケース</h1>

    <button id="showcaseEditTrigger" class="icon-btn" aria-label="ショーケースを編集">
      <img src="{{ url_for('static', filename='img/edit_icon.png') }}" alt="">
    </button>
  </div>

  <section class="showcase-grid" id="showcaseGrid">
    {% for item in showcase_items %}
      {% set p = item['media_path'] %}
      {% if p.endswith(".mp4") or p.endswith(".mov") %}
        <video controls src="{{ p }}" data-id="{{ item['id'] }}" data-type="video"></video>
      {% else %}
        <img src="{{ p }}" alt="" data-id="{{ item['id'] }}" data-type="image"
             style="width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:6px; background:#000;">
      {% endif %}
    {% endfor %}
  </section>
</div>


<!-- ✅ Showcase editor popup (upload + delete) -->
<div id="showcasePopup" class="popup" hidden>
  <div class="popup-content showcase-editor-wrap">
    <div class="popup-head">
      <h2>ショーケースの編集</h2>
      <button id="closeShowcasePopup" class="popup-close" aria-label="閉じる">×</button>
    </div>

    <form id="showcaseForm"
          method="post"
          action="{{ url_for('update_showcase') }}"
          enctype="multipart/form-data">

      <div id="editorGrid" class="editor-grid">
        {% for item in showcase_items %}
          {% set p = item['media_path'] %}
          <div class="tile" data-id="{{ item['id'] }}" data-path="{{ p }}">
            <span class="check" aria-hidden="true"></span>
            <div class="thumb">
              {% if p.endswith(".mp4") or p.endswith(".mov") %}
                <video src="{{ p }}" muted playsinline></video>
              {% else %}
                <img src="{{ p }}" alt="">
              {% endif %}
            </div>
          </div>
        {% endfor %}

        <div class="tile add" id="addTile" role="button" tabindex="0">
          <span class="plus">＋</span>
        </div>

        <div id="uploadInputs" hidden></div>
      </div>

      <div id="deleteInputs"></div>

      <div class="editor-actions">
        <button type="button" id="enterDelete" class="danger">削除</button>
        <div class="delete-mode-actions" hidden>
          <button type="button" id="cancelDelete" class="secondary">キャンセル</button>
          <button type="button" id="confirmDelete" class="danger">削除</button>
        </div>
        <button type="submit" id="saveShowcase" class="primary">保存</button>
      </div>
    </form>
  </div>
</div>


<!-- Chat popup -->
<div id="chatModal" class="chat-modal" hidden>
  <div class="chat-panel">

    <div id="chatListView">
      <div class="chat-head chat-list-head">
        <h2 class="chat-title">メッセージ</h2>
        <button class="chat-close" id="chatCloseBtnList" aria-label="閉じる">×</button>
      </div>
      <ul id="chatConversations" class="chat-list" role="list"></ul>
    </div>

    <div id="chatThreadView" hidden>
      <div class="chat-head chat-thread-head">
        <button class="chat-back" id="chatBackBtn" aria-label="戻る"><svg height="12" width="12" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="m4.431 12.822l13 9A1 1 0 0 0 19 21V3a1 1 0 0 0-1.569-.823l-13 9a1.003 1.003 0 0 0 0 1.645z" fill="currentColor"/>
      </svg></button>
        <h2 id="chatThreadTitle" class="chat-title">Chat</h2>
        <button class="chat-close" id="chatCloseBtnThread" aria-label="閉じる">×</button>
      </div>

      <ol id="chatMessages" class="chat-messages" role="list"></ol>

      <form id="chatSendForm" class="chat-sendbar" autocomplete="off">
        <input id="chatInput" name="message" type="text" placeholder="テキストを入力" aria-label="Message" />
        <button class="chat-send" aria-label="Send">▶</button>
      </form>
    </div>
  </div>
</div>


<!-- Follow modal -->
<div id="followModal" class="popup" hidden>
  <div class="popup-content follow-popup">
    <div class="popup-head">
      <h2 id="followModalTitle">フォロワー</h2>
      <button type="button" class="popup-close" id="closeFollowModal">×</button>
    </div>

    <div id="followEmpty" class="follow-empty" hidden>0</div>
    <ul id="followList" class="follow-list"></ul>
  </div>
</div>

<script>
  window.DEFAULT_AVATAR = "{{ url_for('static', filename='img/profile_icon.png') }}";
  window.PAGE_USER_ID = {{ page_user_id }};
</script>
<script src="{{ url_for('static', filename='js/profile.js', v=1) }}"></script>
</body>
</html>
